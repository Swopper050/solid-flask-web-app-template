import { createSignal, JSXElement, Show } from 'solid-js'
import api from '../api'
import { clsx } from 'clsx'
import { useUser } from '../context'

import { Modal, ModalBaseProps } from "./Modal";

export function Disable2FAModal(props: ModalBaseProps): JSXElement {
  const { fetchUser } = useUser()
  const [totpCode, setTotpCode] = createSignal('')

  const [submitting, setSubmitting] = createSignal(false)
  const [errorMsg, setErrorMsg] = createSignal<string | null>(null)

  let disable2faModalRef: HTMLDialogElement | undefined

  const disable2fa = async () => {
    setErrorMsg(null)
    setSubmitting(true)

    api
      .post('/disable_2fa', { totp_code: totpCode() })
      .then(async () => {
        await fetchUser()
        disable2faModalRef?.close()
      })
      .catch((error) => {
        setErrorMsg(
          error.response.data.error_message ??
            'Could not disable 2FA. Please try again later.'
        )
      })
      .finally(() => {
        setSubmitting(false)
      })
  }

  return (
    <Modal
      title="Disable 2FA"
      isOpen={props.isOpen}
      onClose={props.onClose}
    >
      <div>
        <div>
          <p class="py-4">
            Enter the 6-digit code generated by your authenticator app.
          </p>

          <input
            type="text"
            class="input input-bordered w-full"
            placeholder=""
            value={totpCode()}
            onInput={(e) => setTotpCode(e.target.value)}
          />

          <Show when={errorMsg() !== null}>
            <div role="alert" class="alert alert-error mt-6">
              <span>{errorMsg()}</span>
            </div>
          </Show>

          <div class="modal-action">
            <button
              class={clsx('btn', 'btn-primary', submitting() && 'btn-disabled')}
              onClick={disable2fa}
            >
              <Show when={submitting()}>
                <span class="loading loading-spinner" />
              </Show>
              Disable 2FA
            </button>
          </div>
        </div>
      </div>
    </Modal>
  )
}
